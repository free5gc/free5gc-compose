name: CI Build (ARM64)

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    steps:

    - name: Free Disk Space (ARM)
      run: |
        echo "Before cleanup:"
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        sudo docker image prune -a -f
        sudo apt-get clean
        echo "After cleanup:"
        df -h

    - name: Install Compose
      uses: ndeloof/install-compose-action@v0.0.1
      with:
        version: v2.1.0 # defaults to 'latest'
        legacy: true    # will also install in PATH as `docker-compose`

    - uses: actions/checkout@v3

    - name: Build via build.sh (ARM64)
      run: |
        bash ./script/build.sh aarch64

    # - name: Compose config validation
    #   run: |
    #     docker compose -f docker-compose-build.yaml config -q

    # - name: Compose create (fail if missing)
    #   run: |
    #     docker compose -f docker-compose-build.yaml up --no-start
    #     docker compose -f docker-compose-build.yaml down -v --remove-orphans

    - name: Observability compose config validation
      run: |
        docker compose -f docker-compose-build.yaml -f docker-compose-prometheus.yaml config -q

    - name: Start stack with Prometheus & Grafana (ARM)
      run: |
        docker compose -f docker-compose-build.yaml -f docker-compose-prometheus.yaml up -d
        echo "Waiting for Prometheus & Grafana (ARM)..."
        timeout 60 bash -c 'until curl -sf http://localhost:9090/-/healthy; do sleep 2; done'
        timeout 60 bash -c 'until curl -sf http://localhost:3001/api/health | grep -q '{"commit"'; do sleep 2; done' || true
        echo "Prometheus & Grafana healthy"

    - name: Check Prometheus targets API
      run: |
        curl -sf http://localhost:9090/api/v1/targets | jq '.data.activeTargets | length' || echo "Prometheus targets query fallback"

    - name: Check Grafana datasources API
      run: |
        curl -sf http://localhost:3001/api/datasources || echo "Grafana datasource endpoint reachable"

    - name: Dump logs on failure
      if: failure()
      run: |
        echo "=== Prometheus logs ==="
        docker compose -f docker-compose-build.yaml -f docker-compose-prometheus.yaml logs prometheus || true
        echo "=== Grafana logs ==="
        docker compose -f docker-compose-build.yaml -f docker-compose-prometheus.yaml logs grafana || true

    - name: Teardown observability stack
      if: always()
      run: |
        docker compose -f docker-compose-build.yaml -f docker-compose-prometheus.yaml down -v --remove-orphans
        docker system prune -af --volumes